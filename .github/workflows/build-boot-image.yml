name: Build Kernel and Boot Image

on:
  push:
    branches:
      - main  # Ou a branch que você está usando para build

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout the repository
        uses: actions/checkout@v4

      - name: Set up environment
        run: |
          sudo apt update
          sudo apt install -y git clang gcc make bc bison flex libssl-dev libncurses5-dev
          sudo apt install -y ccache
          sudo apt install -y gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi  # Certifique-se de que o GCC ARM32 está instalado

      - name: Setup Android environment
        run: |
          export ANDROID_DIR=$HOME/android
          mkdir -p $ANDROID_DIR
          cd $ANDROID_DIR
          git clone --depth 1 https://github.com/JoaxTheGoat/ksu.git
          cd ksu

      - name: Compile Kernel
        run: |
          export CROSS_COMPILE_ARM32=arm-linux-gnueabi-  # Definindo o prefixo para ARM32
          make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- CROSS_COMPILE_ARM32=arm-linux-gnueabi- vendor/ginkgo-perf_defconfig
          make -j$(nproc) ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- CROSS_COMPILE_ARM32=arm-linux-gnueabi-

      - name: Build Boot Image
        run: |
          cd ksu
          # Baixar mkbootimg se necessário
          git clone https://android.googlesource.com/platform/system/tools/mkbootimg tools -b master-kernel-build-2022 --depth=1
          # Criando o boot.img
          mkbootimg --kernel ksu/arch/arm64/boot/Image --ramdisk ksu/ramdisk.img --dt ksu/arch/arm64/boot/dtbs/$(ls ksu/arch/arm64/boot/dtbs/ | grep .dtb | head -n 1) --out boot.img

      - name: Upload Boot Image as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: boot-img
          path: boot.img
