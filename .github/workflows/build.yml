name: Kernel 4.14 Build with AnyKernel3

on:
  push:
    branches:
      - main  # Ou a branch que você utiliza

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Passo 1: Fazer checkout do código
      - name: Check out the repository
        uses: actions/checkout@v2

      # Passo 2: Configurar o ambiente
      - name: Set up environment
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential gcc make libncurses5-dev libssl-dev bc bison flex libelf-dev libudev-dev unzip git

      # Passo 3: Baixar AnyKernel3
      - name: Download AnyKernel3
        run: |
          git clone https://github.com/osm0sis/AnyKernel3.git anykernel
          cd anykernel
          git checkout master  # ou uma versão específica, caso precise

      # Passo 4: Configurar o Kernel
      - name: Configure Kernel
        run: |
          cd kernel
          make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- defconfig  # Mude conforme sua arquitetura

      # Passo 5: Compilar o Kernel
      - name: Build Kernel
        run: |
          cd kernel
          make -j$(nproc) ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu-  # Ajuste o número de núcleos conforme seu CI

      # Passo 6: Empacotar o kernel com AnyKernel3
      - name: Package with AnyKernel3
        run: |
          cd anykernel
          cp ../kernel/arch/arm64/boot/Image .  # Ou ajuste o caminho do seu arquivo de imagem
          cp ../kernel/arch/arm64/boot/dtbs/*.dtb .  # Ajuste conforme necessário para os arquivos .dtb
          # Se for necessário, adicione o initramfs ou outros arquivos
          zip -r9 AnyKernel3.zip *  # Cria o arquivo .zip

      # Passo 7: Salvar o arquivo .zip
      - name: Upload Kernel Zip
        uses: actions/upload-artifact@v3  # Atualizado para v3
        with:
          name: anykernel-zip
          path: anykernel/AnyKernel3.zip
