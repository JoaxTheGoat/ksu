name: Build-Ginkgo-Final

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Baixando o Código
        uses: actions/checkout@v4
        with:
          ref: thirteen

      - name: Limpar Runner + Instalar Dependências
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt-get update
          # Instala o GCC 10 (Cross-Compiler) que é compatível com kernels 4.14
          sudo apt-get install -y \
            bc build-essential flex bison libssl-dev libelf-dev make libncurses5-dev git \
            gcc-10-aarch64-linux-gnu \
            gcc-10-arm-linux-gnueabi \
            device-tree-compiler

      - name: Configurar e Compilar Kernel
        run: |
          # Define os caminhos dos compiladores
          export CROSS_COMPILE=aarch64-linux-gnu-
          export CROSS_COMPILE_ARM32=arm-linux-gnueabi-
          
          # Cria a pasta de saída
          mkdir -p out
          
          # Define o número de núcleos para a compilação
          CORES=$(nproc --all)
          [ "$CORES" -gt 8 ] && CORES=8 # Limite de segurança para o runner do GitHub
          
          echo "Usando $CORES núcleos para a compilação"

          # 1. Gera a configuração (Ginkgo)
          make O=out ARCH=arm64 vendor/ginkgo-perf_defconfig

          # 2. Compilação (Ajustada para o Ubuntu novo)
          # O KCFLAGS="-w" evita que a build pare por causa de avisos de código antigo
          make -j$CORES O=out ARCH=arm64 \
            CROSS_COMPILE=$CROSS_COMPILE \
            CROSS_COMPILE_ARM32=$CROSS_COMPILE_ARM32 \
            CC=aarch64-linux-gnu-gcc-10 \
            LD=aarch64-linux-gnu-ld \
            AR=aarch64-linux-gnu-ar \
            NM=aarch64-linux-gnu-nm \
            OBJCOPY=aarch64-linux-gnu-objcopy \
            OBJDUMP=aarch64-linux-gnu-objdump \
            STRIP=aarch64-linux-gnu-strip \
            HOSTCC=gcc \
            HOSTCXX=g++ \
            KCFLAGS="-w" # Ignora avisos durante a compilação

      - name: Upload do Kernel
        uses: actions/upload-artifact@v4
        with:
          name: Kernel-Ginkgo-Final
          # Usamos o asterisco para garantir que pegue Image.gz ou Image.gz-dtb
          path: out/arch/arm64/boot/Image.gz*
